<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Karin - AI Task Reminder</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    :root { --bg:#0b1020; --card:#111831; --muted:#9fb0ff; --text:#eef2ff; --accent:#6aa3ff; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Arial; background: linear-gradient(120deg,#0b1020,#0f1530 60%,#0b1020); color: var(--text); }
    .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    .title { font-weight: 800; font-size: 28px; letter-spacing: .3px; margin-bottom: 16px; }
    .subtitle { color: var(--muted); margin-bottom: 24px; }
    .grid { display: grid; grid-template-columns: repeat(12,1fr); gap: 16px; }
    .card { grid-column: span 12; background: radial-gradient(100% 100% at 100% 0%, rgba(106,163,255,.15), transparent 40%), var(--card);
            border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.3); }
    @media(min-width:900px){ .span6{grid-column: span 6;} .span8{grid-column: span 8;} .span4{grid-column: span 4;} }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing:.8px; }
    input, textarea, select { width: 100%; background: #0c1230; color: var(--text); border: 1px solid rgba(255,255,255,.1);
       border-radius: 10px; padding: 10px 12px; outline: none; }
    textarea { min-height: 110px; resize: vertical; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { appearance: none; border: 1px solid rgba(255,255,255,.12); background: linear-gradient(180deg,#1b254a,#162040);
           color: var(--text); padding: 10px 14px; border-radius: 10px; cursor: pointer; transition:.2s transform, .2s opacity, .2s border;
           font-weight: 600; }
    .btn:hover { transform: translateY(-1px); border-color: rgba(106,163,255,.5); }
    .btn.ok { background: linear-gradient(180deg,#1f9d55,#15803d); border-color: rgba(34,197,94,.5); }
    .btn.warn { background: linear-gradient(180deg,#c07d21,#a16207); border-color: rgba(245,158,11,.5); }
    .btn.danger { background: linear-gradient(180deg,#c2410c,#9a3412); border-color: rgba(239,68,68,.5); }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(106,163,255,.2); color: var(--text); font-size: 12px; border: 1px solid rgba(106,163,255,.4); }
    .list { margin-top: 8px; max-height: 260px; overflow: auto; border:1px solid rgba(255,255,255,.06); border-radius:12px; }
    .item { display:flex; gap:10px; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom: 1px dashed rgba(255,255,255,.06); }
    .item:last-child { border-bottom: none; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">AI Task Reminder</div>
    <div class="subtitle">Nh·∫≠p <span class="pill">Prompt</span>, email nh·∫≠n th√¥ng b√°o, th√™m task h·∫±ng ng√†y, <strong>Ch·∫°y ngay</strong> ho·∫∑c <strong>C√†i l·ªãch</strong>. Kh√¥ng c·∫ßn m·ªü Google Sheet.</div>

    <div class="grid">
      <!-- SETTINGS -->
      <div class="card span6">
        <h3 style="margin:0 0 8px 0;">C√†i ƒë·∫∑t</h3>
        <div class="row">
          <div style="flex:1;">
            <label>Email nh·∫≠n th√¥ng b√°o</label>
            <input id="email" placeholder="you@example.com">
          </div>
        </div>
        <div style="margin-top:10px;">
          <label>Prompt AI</label>
          <textarea id="prompt"></textarea>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="btn ok" onclick="saveSettings()">üíæ L∆∞u c√†i ƒë·∫∑t</button>
          <button class="btn" onclick="runNow()">‚ñ∂Ô∏è Ch·∫°y ngay</button>
        </div>
        <div id="settingsMsg" class="muted" style="margin-top:8px;"></div>
      </div>

      <!-- SCHEDULE -->
      <div class="card span6">
        <h3 style="margin:0 0 8px 0;">L·ªãch ch·∫°y</h3>
        <div class="row">
          <div style="flex:1;">
            <label>Ch·∫ø ƒë·ªô</label>
            <select id="mode">
              <option value="minutes">M·ªói X ph√∫t</option>
              <option value="daily">H·∫±ng ng√†y l√∫c gi·ªù H</option>
            </select>
          </div>
          <div style="width:160px;">
            <label>Gi√° tr·ªã</label>
            <input id="value" type="number" placeholder="v√≠ d·ª• 15 ho·∫∑c 8">
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="btn warn" onclick="setSchedule()">üïí C√†i l·ªãch</button>
          <button class="btn danger" onclick="clearSchedule()">üßπ Xo√° l·ªãch</button>
        </div>
        <div id="scheduleMsg" class="muted" style="margin-top:8px;"></div>
      </div>

      <!-- ADD TASK -->
      <div class="card span8">
        <h3 style="margin:0 0 8px 0;">Th√™m Task</h3>
        <div class="row">
          <div style="flex:1;">
            <label>N·ªôi dung task</label>
            <input id="taskText" placeholder='V√≠ d·ª•: "G·ª≠i b√°o c√°o tu·∫ßn"'>
          </div>
          <div style="width:220px;">
            <label>Deadline</label>
            <input id="deadline" type="date">
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="btn ok" onclick="addTask()">‚ûï Th√™m task</button>
        </div>
        <div id="taskMsg" class="muted" style="margin-top:8px;"></div>
      </div>

      <!-- UPCOMING TASKS -->
      <div class="card span4">
        <h3 style="margin:0 0 8px 0;">S·∫Øp t·ªõi</h3>
        <div id="list" class="list"></div>
        <div id="empty" class="muted" style="display:none;">Ch∆∞a c√≥ task.</div>
      </div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);

    // üëâ ƒë·ªïi ch·ªó n√†y th√†nh GAS webapp URL th·∫≠t
    const GAS_URL = "https://script.google.com/macros/s/AKfycbykGQhqNv-wSqAdcnnENI-fbnOmQwK3RkK6gbeQ98H9ZRXwatYIuGU5bNmyVl8csLUEvg/exec";

    async function callGAS(action, params={}) {
      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action, ...params })
        });
        return await res.json();
      } catch (err) {
        console.error(err);
        return { error: err.message || "L·ªói k·∫øt n·ªëi" };
      }
    }

    function renderTasks(tasks) {
      const list = $("#list"); list.innerHTML = "";
      if (!tasks || tasks.length === 0) { $("#empty").style.display = "block"; return; }
      $("#empty").style.display = "none";
      tasks.forEach(t => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <div><strong>#${t.id}</strong> ‚Äî ${t.task}</div>
            <div class="muted">‚è∞ ${t.deadlineStr} ‚Äî c√≤n ${t.diffDays} ng√†y ${t.done ? "(ƒë√£ xong)" : ""}</div>
          </div>
          <div>
            ${t.done ? "" : `<button class="btn" onclick="markDone(${t.id})">‚úîÔ∏è Done</button>`}
          </div>
        `;
        list.appendChild(div);
      });
    }

    async function load() {
      const data = await callGAS("getInitData");
      if (data.error) return alert("‚ùå " + data.error);
      $("#prompt").value = data.prompt || "";
      $("#email").value  = data.email  || "";
      $("#scheduleMsg").textContent = data.schedule?.label || "";
      renderTasks(data.tasks || []);
    }

    async function saveSettings() {
      const email = $("#email").value.trim();
      const prompt = $("#prompt").value.trim();
      $("#settingsMsg").textContent = "ƒêang l∆∞u...";
      const r1 = await callGAS("saveRecipientEmail", { email });
      const r2 = await callGAS("savePrompt", { prompt });
      $("#settingsMsg").textContent = `‚úÖ ${r1.message} ‚Äî ${r2.message}`;
    }

    async function runNow() {
      $("#settingsMsg").textContent = "ƒêang ch·∫°y...";
      const r = await callGAS("runNow");
      $("#settingsMsg").textContent = r.message ? "‚úÖ " + r.message : "‚ùå " + r.error;
      load();
    }

    async function setSchedule() {
      const mode = $("#mode").value;
      const value = $("#value").value.trim();
      $("#scheduleMsg").textContent = "ƒêang c√†i l·ªãch...";
      const r = await callGAS("setSchedule", { mode, value });
      $("#scheduleMsg").textContent = r.message ? "‚úÖ " + r.message : "‚ùå " + r.error;
    }

    async function clearSchedule() {
      const r = await callGAS("clearSchedule");
      $("#scheduleMsg").textContent = r.message ? "‚úÖ " + r.message : "‚ùå " + r.error;
    }

    async function addTask() {
      const text = $("#taskText").value.trim();
      const deadline = $("#deadline").value;
      if (!text || !deadline) { $("#taskMsg").textContent = "‚ö†Ô∏è ƒêi·ªÅn ƒë·ªß task & deadline."; return; }
      $("#taskMsg").textContent = "ƒêang th√™m‚Ä¶";
      const r = await callGAS("addTask", { text, deadline });
      $("#taskMsg").textContent = r.message ? "‚úÖ " + r.message : "‚ùå " + r.error;
      if (r.message) { $("#taskText").value = ""; $("#deadline").value = ""; load(); }
    }

    async function markDone(id) {
      await callGAS("markDone", { id });
      load();
    }

    document.addEventListener("DOMContentLoaded", load);
  </script>
</body>
</html>
